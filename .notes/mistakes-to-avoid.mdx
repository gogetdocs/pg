### Key Valid Mistakes and Better Ways of Doing Things in PostgreSQL

#### 1. **Incorrect Use of `NOT IN`**

- **Mistake**: Using `NOT IN` with subqueries that may contain `NULL` values.
  ```sql
  SELECT a FROM table_one WHERE a NOT IN (SELECT b FROM table_two);
  ```
- **Problem**: If `table_two` contains `NULL` values, the entire result will be `NULL`, not `FALSE`.
- **Better Way**: Use `NOT EXISTS` or `LEFT JOIN` instead.
  ```sql
  SELECT a FROM table_one WHERE NOT EXISTS (SELECT 1 FROM table_two WHERE table_one.a = table_two.b);
  ```
  ```sql
  SELECT a FROM table_one LEFT JOIN table_two ON table_one.a = table_two.b WHERE table_two.b IS NULL;
  ```

#### 2. **Misunderstanding `BETWEEN`**

- **Mistake**: Using `BETWEEN` without understanding its inclusivity.
  ```sql
  SELECT sum(amount) FROM transactions WHERE transaction_timestamp BETWEEN '2023-02-01 00:00:00' AND '2023-02-01 23:59:59';
  ```
- **Problem**: `BETWEEN` is inclusive, which can lead to double-counting if not used carefully.
- **Better Way**: Use explicit comparisons instead.
  ```sql
  SELECT sum(amount) FROM transactions WHERE transaction_timestamp >= '2023-02-01 00:00:00' AND transaction_timestamp < '2023-02-02 00:00:00';
  ```

#### 3. **Using Uppercase Identifiers**

- **Mistake**: Using uppercase or mixed-case identifiers without double quotes.
  ```sql
  CREATE TABLE Plurp (id SERIAL PRIMARY KEY);
  ```
- **Problem**: PostgreSQL converts identifiers to lowercase unless they are enclosed in double quotes, leading to confusion.
- **Better Way**: Use lowercase identifiers or enclose them in double quotes.
  ```sql
  CREATE TABLE plurp (id SERIAL PRIMARY KEY);
  ```

#### 4. **Incorrect Use of Timestamps**

- **Mistake**: Using `timestamp` without time zone.
  ```sql
  CREATE TABLE events (event_time timestamp);
  ```
- **Problem**: This can lead to confusion and errors when dealing with different time zones.
- **Better Way**: Use `timestamp with time zone` (or `timestamptz`).
  ```sql
  CREATE TABLE events (event_time timestamptz);
  ```

#### 5. **Using `CHAR(n)`**

- **Mistake**: Using `CHAR(n)` for string storage.
  ```sql
  CREATE TABLE users (name CHAR(255));
  ```
- **Problem**: `CHAR(n)` pads strings with whitespace, leading to inefficiencies and potential errors.
- **Better Way**: Use `text` (or `varchar` without a length specifier).
  ```sql
  CREATE TABLE users (name text);
  ```

#### 6. **Using `MONEY` Type**

- **Mistake**: Using the `MONEY` type for financial data.
  ```sql
  CREATE TABLE transactions (amount MONEY);
  ```
- **Problem**: `MONEY` has fixed-point precision, which can lead to rounding errors, and it does not store currency information.
- **Better Way**: Use `numeric` and store currency in a separate column.
  ```sql
  CREATE TABLE transactions (amount numeric, currency text);
  ```

#### 7. **Using `SERIAL`**

- **Mistake**: Using `SERIAL` for auto-incrementing IDs.
  ```sql
  CREATE TABLE users (id SERIAL PRIMARY KEY);
  ```
- **Problem**: `SERIAL` is non-standard and can lead to permissions issues.
- **Better Way**: Use `IDENTITY` columns.
  ```sql
  CREATE TABLE users (id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY);
  ```

#### 8. **Incorrect Use of Character Encoding**

- **Mistake**: Using `SQL_ASCII` encoding.
  ```sql
  CREATE DATABASE mydb WITH ENCODING 'SQL_ASCII';
  ```
- **Problem**: `SQL_ASCII` skips encoding validation, which can lead to data corruption.
- **Better Way**: Use `UTF-8` encoding.
  ```sql
  CREATE DATABASE mydb WITH ENCODING 'UTF8';
  ```

#### 9. **Using Rules**

- **Mistake**: Using rules for conditional logic.
  ```sql
  CREATE RULE myrule AS ON INSERT TO mytable DO INSTEAD NOTHING;
  ```
- **Problem**: Rules can have unintended consequences and are non-standard.
- **Better Way**: Use triggers instead.
  ```sql
  CREATE TRIGGER mytrigger BEFORE INSERT ON mytable FOR EACH ROW EXECUTE PROCEDURE myfunction();
  ```

#### 10. **Incorrect Use of Table Inheritance**

- **Mistake**: Using table inheritance for data modeling.
  ```sql
  CREATE TABLE events (id SERIAL PRIMARY KEY);
  CREATE TABLE meetings (CHECK (false)) INHERITS (events);
  ```
- **Problem**: Table inheritance can lead to data inconsistencies and is incompatible with partitioning.
- **Better Way**: Use foreign key relationships instead.
  ```sql
  CREATE TABLE events (id SERIAL PRIMARY KEY);
  CREATE TABLE meetings (id SERIAL PRIMARY KEY, event_id INTEGER REFERENCES events(id));
  ```

#### 11. **Incorrect Partitioning**

- **Mistake**: Using multiple keys for partitioning without sub-partitioning.
  ```sql
  CREATE TABLE transactions (location_code text, timestamp timestamptz) PARTITION BY RANGE (timestamp, location_code);
  ```
- **Problem**: This can lead to overlapping partitions.
- **Better Way**: Use sub-partitioning instead.
  ```sql
  CREATE TABLE transactions (location_code text, timestamp timestamptz) PARTITION BY RANGE (timestamp);
  CREATE TABLE transactions_202302 PARTITION OF transactions FOR VALUES FROM ('2023-02-01') TO ('2023-03-01') PARTITION BY HASH (location_code);
  ```

#### 12. **Performance Issues**

- **Mistake**: Accepting too many connections.
  ```sql
  ALTER SYSTEM SET max_connections = 5000;
  ```
- **Problem**: This can lead to performance degradation due to context switching and lock contention.
- **Better Way**: Use a connection pooler like `pgbouncer`.

  ```sql
  ALTER SYSTEM SET max_connections = 100;
  ```

- **Mistake**: Turning off `autovacuum`.
  ```sql
  ALTER SYSTEM SET autovacuum_vacuum_scale_factor = 0;
  ```
- **Problem**: This can lead to data bloat and transaction ID wraparound.
- **Better Way**: Adjust `autovacuum` settings for better performance.
  ```sql
  ALTER SYSTEM SET autovacuum_vacuum_scale_factor = 0.1;
  ```

### 13. **Security Issues**

- **Mistake**: Using `trust` authentication method over TCP/IP connections.
  ```sql
  host    all             all             127.0.0.1/32            trust
  ```
- **Problem**: This allows anyone who can connect to the database server to access any database without a password, which is a significant security risk.
- **Better Way**: Use secure authentication methods such as `md5`, `scram-sha-256`, or `cert` instead.

  ```sql
  host    all             all             127.0.0.1/32            md5
  ```

- **Mistake**: Not using SSL/TLS encryption for connections.
  ```sql
  ssl = off
  ```
- **Problem**: This exposes data in transit to eavesdropping and tampering.
- **Better Way**: Enable SSL/TLS encryption.

  ```sql
  ssl = on
  ssl_cert_file = 'server.crt'
  ssl_key_file = 'server.key'
  ```

- **Mistake**: Not regularly updating and patching PostgreSQL.
  ```sql
  # Not updating PostgreSQL regularly
  ```
- **Problem**: This leaves the database vulnerable to known security issues.
- **Better Way**: Regularly update and patch PostgreSQL to ensure the latest security fixes are applied.

  ```sql
  # Regularly run
  sudo apt update && sudo apt upgrade postgresql
  ```

- **Mistake**: Not limiting database privileges.
  ```sql
  GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;
  ```
- **Problem**: This gives unnecessary access to database objects, increasing the risk of data breaches.
- **Better Way**: Grant only necessary privileges to users.

  ```sql
  GRANT SELECT, INSERT, UPDATE ON TABLE mytable TO myuser;
  ```

- **Mistake**: Not monitoring database logs.
  ```sql
  # Not configuring logging
  ```
- **Problem**: This makes it difficult to detect and respond to security incidents.
- **Better Way**: Configure and monitor database logs.
  ```sql
  logging_collector = on
  log_destination = 'stderr'
  log_directory = 'pg_log'
  ```
